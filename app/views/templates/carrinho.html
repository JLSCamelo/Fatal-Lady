<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrinho - Fatal Lady</title>
  <link rel="icon" href="/static/uploads/img/main_icon/icon.png" type="image/png">
  <link rel="stylesheet" href="{{ url_for('static', path='css/carrinho.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/cart-badge.css') }}" />
</head>

<body data-is-authenticated="{% if usuario %}true{% else %}false{% endif %}">
  <header id="main_header">
    <div class="header-div">
      <img src="/static/uploads/img/home/icons-main/languages.png" id="language-icon" />
      <select name="language" id="language">
        <option value="br">BR</option>
        <option value="en">EN</option>
        <option value="es">ES</option>
      </select>
    </div>

    <div class="header-div">
      <div class="promo-rotator" role="status" aria-live="polite" aria-atomic="true">
        <span id="promo-text" class="promo-text"><b>Frete Grátis</b> para Compras Acima de R$ 299,00</span>
      </div>
    </div>

    <div class="header-div">
      {% if usuario.is_admin == True %}
      <a href="/admin" style="color: rgb(223, 16, 16);">Painel do Admin</a>
      {% else %}
      <a href="#">Ajuda</a>
      {% endif %}
      {% if usuario %}
      <a href="/me/painel">Olá, {{ usuario.nome.split(' ')[0] }}</a>
      {% else %}
      <a href="/login">Entrar</a>
      {% endif %}
    </div>
  </header>

  <nav>
    <div class="nav-div">
      <a href="/" class="text_sections">Início</a>
      <a href="/produtos" class="text_sections">Catálogo</a>
      <a href="/carrinho" class="text_sections">Carrinho</a>
    </div>

    <div class="nav-div">
      <a href="/">
        <img src="/static/uploads/img/home/icons-main/letreiro-logo.png" id="logo" alt="Logo" />
      </a>
    </div>

    <div class="nav-div">
      {% if usuario.is_admin == True %}
      <a href="/admin">
        <img src="/static/uploads/img/home/icons-main/shield-check.png" id="kart-icon" class="icons" />
      </a>
      <a href="/dashboard">
        <img src="/static/uploads/img/home/icons-main/dashboard-panel.png" id="kart-icon" class="icons" />
      </a>
      {% endif %}
      <div class="cart-link-wrapper">
        <a href="/carrinho">
          <img src="/static/uploads/img/home/icons-main/kart.png" id="kart-icon" class="icons" />
        </a>
      </div>
      <a href="/produtos">
        <img src="/static/uploads/img/home/icons-main/shop.png" id="shop-icon" class="icons" />
      </a>
      {% if usuario %}
      <a href="/me/painel">
        <img src="/static/uploads/img/home/icons-main/user.png" id="user-icon" class="icons" />
      </a>
      {% else %}
      <a href="/login">
        <img src="/static/uploads/img/home/icons-main/user.png" id="user-icon" class="icons" />
      </a>
      {% endif %}
    </div>
  </nav>

  <main class="cart-container" id="main" role="main">
    <div class="cart-header" aria-hidden="false">
      <h1>Meu Carrinho</h1>
      <p>Revise seus produtos antes de finalizar a compra</p>
    </div>

    {% if carrinho %}
    <div class="cart-content" role="region" aria-label="Itens do carrinho">
      <div class="cart-items">
        {% for item in carrinho %}
        <div class="cart-item" data-product-id="{{ item.produto_id }}" aria-labelledby="item-name-{{ loop.index }}">
          <div class="item-image">
            <img src="/static/uploads/img/catalogo/products/default.png" alt="{{ item.id }}">
          </div>
          <div class="item-details">
            <div id="item-name-{{ loop.index }}" class="item-name">{{ item.produto.nome }}</div>
            <div class="item-id">ID: {{ item.produto_id }}</div>
            <div class="item-price" data-price="{{ item.preco_unitario }}">R$ {{ item.preco_unitario }}</div>
          </div>
          <div class="item-controls">
            <form action="/carrinho/editar/{{item.produto_id }}" method="post" class="form-update-cart">

              <input type="hidden" name="tamanho" value="{{ item.tamanho }}">

              <div class="size-display">
                Tamanho: {{ item.tamanho }}
              </div>

              <div class="quantity-control">
                <button type="button" class="btn-qty-minus" data-action="decrement">-</button>

                <input type="number" name="quantidade" value="{{ item.quantidade }}" min="1" class="input-quantity"
                  aria-label="Quantidade">

                <button type="button" class="btn-qty-plus" data-action="increment">+</button>
              </div>

            </form>

            <form action="/carrinho/remover/{{ item.produto_id }}" method="post" aria-label="Remover">
              <button type="submit" class="btn-remove">Remover</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
      <aside class="cart-summary" role="complementary" aria-label="Resumo do pedido">
        <div class="summary-title">Resumo do Pedido</div>

        <!-- SUBTOTAL -->
        <div class="summary-row">
          <span>Subtotal:</span>
          <span id="subtotal" data-valor="{{ '%.2f'|format(total|float) }}">
            R$ {{ '%.2f'|format(total|float) }}
          </span>
        </div>

        <!-- FRETE / ENDEREÇO -->
        <div class="summary-row">
          <div id="resultadoFrete" style="display: none;">
            <div class="summary-row">
              <span>Endereço:</span>
              <span id="endereco">
                {{ usuario.enderecos[0].rua if usuario.enderecos else '' }}
              </span>
            </div>

            <div class="summary-row">
              <span>Frete:</span>
              <span id="valor_frete">0.00</span>
            </div>

            <div class="summary-row">
              <span>Prazo:</span>
              <span id="prazo"></span>
            </div>
          </div>
          <button type="button" id="btnCalcularFrete">Calcular Frete</button>
        </div>

        <!-- TOTAL -->
        <div class="summary-row total">
          <span>Total:</span>
          <span id="total">
            R$ {{ '%.2f'|format(total|float) }}
          </span>
        </div>

        <!-- CAMPOS HIDDEN QUE O JS USA -->
        <form action="/checkout" method="post">
          <input type="hidden" id="cepHidden" name="cep_destino">
          <input type="hidden" id="enderecoHidden" name="endereco_entrega">
          <input type="hidden" id="freteHidden" name="valor_frete">
          <input type="hidden" id="totalHidden" name="total_pagar">
          <button type="submit" class="btn-checkout">Finalizar Compra</button>
        </form>

        <a href="/produtos" class="btn-continue">Continuar Comprando</a>
      </aside>


    </div>
    {% else %}
    <div class="empty-cart" role="status" aria-live="polite">
      <img src="/static/uploads/img/carrinho/kart_alert.png" alt="Carrinho Vazio">
      <h2>Seu carrinho está vazio</h2>
      <p>Adicione produtos e volte aqui para finalizar sua compra!</p>
      <a href="/produtos" class="btn-continue-empty">Explorar Produtos</a>
    </div>
    {% endif %}
  </main>

  <!-- Footer padronizado (conteúdo padronizado com index) -->
  <footer role="contentinfo">
    <div class="footer-links">
      <div>
        <h4>Minha Conta</h4>
        <a href="#">Meus Dados</a>
        <a href="#">Meus Pedidos</a>
        <a href="#">Cashback</a>
        <a href="#">Login</a>
      </div>
      <div>
        <h4>Suporte e Políticas</h4>
        <a href="#">Trocas e Devoluções</a>
        <a href="#">Dúvidas Frequentes</a>
        <a href="#">Fale Conosco</a>
        <a href="#">Política de Privacidade</a>
      </div>
      <div>
        <h4>Formas de Pagamento</h4>
        <img src="/static/uploads/img/catalogo/footer/payment.png" alt="Formas de Pagamento">
      </div>
    </div>
    <hr>
    <p class="copy">Coffe and Code | © 2025 Todos os direitos reservados</p>
  </footer>

  <script src="/static/js/carrinho.js" defer></script>
  <script src="/static/js/promo-rotator.js" defer></script>
  <script src="/static/js/cart-badge.js" defer></script>
  <script>
    const cepUsuario = "{{ usuario.enderecos[0].cep if usuario.enderecos else '' }}";
  </script>
  <script src="/static/js/frete-calcular.js" defer></script>
</body>

</html>